<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Independent UA</title>
    <meta name="author" content="Adam Narozniak, Alessandro Tavazzi, Nicolas dâ€™Argenlieu"/>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>

<body>
<h1> Casualties </h1>
<div id="my_dataviz">

</div>
<div id="learn_plot"></div>
<script>
    class CasualtiesLoader {
        #casualties;
        date_to_civilians_killed;
        date_to_children_killed;
        date_to_civilians_injured;
        date_to_children_injured;

        constructor(path) {
            this.path = path;
        }

        async load_data() {
            this.#casualties = await d3.csv(this.path);
            // this callback is necessary in this function if I want to store the data in the line above
            this._extract_data()
        }

        _extract_data() {
            this.date_to_civilians_killed = this._extract_one_data("civilians_killed");
            this.date_to_children_killed = this._extract_one_data("children_killed");
            this.date_to_civilians_injured = this._extract_one_data("civilians_injured");
            this.date_to_children_injured = this._extract_one_data("children_injured");

        }

        _extract_one_data(column_name) {
            const parseTime = d3.timeParse("%Y-%m-%d");
            return new Map(
                this.#casualties.map(
                    object => {
                        return [parseTime(object["date"]), Number(object[column_name])]
                    })
            )
        }
    }


    let casualtiesPath = "./../../data/casualtiesUNHumanRightsUATweets.csv";
    let casualtiesLoader = new CasualtiesLoader(casualtiesPath);
    let promise = casualtiesLoader.load_data().then(
        () => plot_casualties()
    );


    function plot_casualties() {
        const margin = {top: 10, right: 30, bottom: 30, left: 60},
            width = 900 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;
        const r = 3;
        const svg = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        const dateScale = d3.scaleTime()
            .domain([d3.min(Array.from(casualtiesLoader.date_to_civilians_killed.keys())),
                d3.max(Array.from(casualtiesLoader.date_to_civilians_killed.keys()))])
            .range([0, width]);
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(dateScale));
        // Add Y axis
        const valuesScale = d3.scaleLinear()
            .domain([0, 4000])
            .range([height, 0]);
        svg.append("g")
            .call(d3.axisLeft(valuesScale));
        plot(casualtiesLoader.date_to_civilians_killed, svg, r, dateScale, valuesScale)
    }

    function plot(data, svg, r, dateScale, valuesScale) {

        // Add the line
        svg.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "#69b3a2")
            .attr("stroke-width", 1.5)
            .attr("d", d3.line()
                .x(function (d) {
                    return dateScale(d[0])
                })
                .y(function (d) {
                    return valuesScale(d[1]) + r
                })
            );


        // Add the points
        svg.append("g")
            .selectAll("dot")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", function (d) {
                return dateScale(d[0])
            })
            .attr("cy", function (d) {
                return valuesScale(d[1]) + r
            })
            .attr("r", r)
            .attr("fill", "#69b3a2");
    }


</script>
</body>
</html>